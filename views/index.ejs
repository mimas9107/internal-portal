<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Internal Portal</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <h1>Internal Portal</h1>
    <table>
        <thead>
            <tr>
                <th>æœå‹™</th>
                <th>ç‹€æ…‹</th>
                <th>ä¸Šæ¬¡æª¢æŸ¥</th>
                <th>ç®¡ç†</th>
            </tr>
        </thead>
        <tbody>
        <% services.forEach(function(s) { %>
            <tr id="service-<%= s.name %>" class="service-row">
                <td><%= s.name %></td>
                <td>
                    <span class="status">
                    <% if (s.online) { %>
                        <span class="status-online">ğŸŸ¢ Online</span>
                    <% } else { %>
                        <span class="status-offline">ğŸ”´ Offline</span>
                    <% } %>
                    </span>
                </td>
                <td class="last-checked">
                    <% if(s.lastChecked === null){ %>
                        å°šæœªæª¢æŸ¥
                    <% } else { %>
                        <%= Math.round((Date.now()-s.lastChecked)/1000) %> ç§’å‰
                    <% } %>
                </td>
                <td>
                    <% if (s.online && s.url.startsWith('/check/')) { %>
                        <a href="<%= s.url %>" class="button button-online">æ¸¬è©¦</a>
                    <% } else if (s.online && s.url !== '-') { %>
                        <a href="<%= s.url %>" target="_blank" class="button button-online">å‰å¾€</a>
                    <% } else if (s.url === '-') { %>
                        <span style="color:gray">ç„¡ç®¡ç†é é¢</span>
                    <% } else { %>
                        <button class="button button-offline" disabled>ç„¡æ³•é€£ç·š</button>
                    <% } %>
                </td>
            </tr>
        <% }); %>
        </tbody>
    </table>

    <!-- Step 3: å‹•æ…‹æ›´æ–°è…³æœ¬å€å¡Š -->
    <script>
        const serviceNames = <%- JSON.stringify(services.map(s => s.name)) %>;

        function updateService(name) {
            fetch(`/api/service/${name}`)
                .then(res => res.json())
                .then(data => {
                    const row = document.getElementById(`service-${data.name}`);
                    if (!row) return;

                    const statusTd = row.querySelector('.status');
                    const lastCheckedTd = row.querySelector('.last-checked');

                    // ç‹€æ…‹åœ–ç¤ºï¼ˆOnline/Offlineï¼‰
                    statusTd.innerHTML = data.online
                        ? '<span class="status-online">ğŸŸ¢ Online</span>'
                        : '<span class="status-offline">ğŸ”´ Offline</span>';

                    // ç§’æ•¸é¡¯ç¤º
                    if (data.lastChecked) {
                        const secondsAgo = Math.round((Date.now() - data.lastChecked) / 1000);
                        lastCheckedTd.textContent = `${secondsAgo} ç§’å‰`;
                    } else {
                        lastCheckedTd.textContent = 'å°šæœªæª¢æŸ¥';
                    }
                })
                .catch(err => console.error('æ›´æ–°å¤±æ•—:', name, err));
        }

        // æ¯ 1 ç§’åˆ·æ–°ä¸€æ¬¡æ‰€æœ‰æœå‹™ï¼ˆä¹‹å¾Œå¯è‡ªè¨‚æ¯é …é »ç‡ï¼‰
        setInterval(() => {
            serviceNames.forEach(updateService);
        }, 1000);
    </script>
</body>
</html>

